// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User - Linked to Clerk
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  progress  UserProgress[]
  sessions  Session[]
  pageViews PageView[]
}

// Lesson - Curriculum unit (3 total)
model Lesson {
  id          String   @id @default(cuid())
  order       Int      @unique
  title       String
  description String
  strategyTag String // "make-10", "doubles", "choosing-strategies"
  createdAt   DateTime @default(now())

  subLessons SubLesson[]
  items      LessonItem[]
  progress   UserProgress[]
}

// SubLesson - Targeted remediation topic
model SubLesson {
  id               String   @id @default(cuid())
  lessonId         String
  title            String
  description      String
  order            Int
  diagnosticPrompt String

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, order])
}

// LessonItem - Individual question
model LessonItem {
  id          String @id @default(cuid())
  lessonId    String
  question    String // e.g., "8 + 5 = ?"
  answer      Int
  strategyTag String // Tag for AI feedback routing
  order       Int

  lesson    Lesson             @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  responses SessionResponse[]

  @@unique([lessonId, order])
}

// UserProgress - Track mastery per lesson
model UserProgress {
  id           String   @id @default(cuid())
  userId       String
  lessonId     String
  masteryScore Float    @default(0)
  completed    Boolean  @default(false)
  lastAttempt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

// Session - Quiz attempt
model Session {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  startedAt DateTime @default(now())
  score     Float?
  passed    Boolean  @default(false)

  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  responses SessionResponse[]
}

// SessionResponse - Single question response
model SessionResponse {
  id        String   @id @default(cuid())
  sessionId String
  itemId    String
  answer    Int
  isCorrect Boolean
  timeMs    Int // Response time

  session Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  item    LessonItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

// PageView - Track user page visits for analytics
model PageView {
  id               String   @id @default(cuid())
  userId           String
  page             String   // e.g., "/dashboard", "/lesson/abc123"
  timestamp        DateTime @default(now())
  sessionDuration  Int?     // Duration in milliseconds
  referrer         String?
  metadata         String?  // JSON string for additional data

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
  @@index([page])
}
