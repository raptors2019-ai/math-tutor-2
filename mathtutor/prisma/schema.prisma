generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String         @id @default(cuid())
  clerkId   String         @unique
  email     String         @unique
  firstName String?
  lastName  String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  sessions  Session[]
  progress  UserProgress[]
}

model Lesson {
  id          String         @id @default(cuid())
  order       Int            @unique
  title       String
  description String
  strategyTag String
  createdAt   DateTime       @default(now())
  items       LessonItem[]
  subLessons  SubLesson[]
  progress    UserProgress[]
}

model SubLesson {
  id               String @id @default(cuid())
  lessonId         String
  title            String
  description      String
  order            Int
  diagnosticPrompt String
  lesson           Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, order])
}

model LessonItem {
  id          String            @id @default(cuid())
  lessonId    String
  question    String
  answer      Int
  strategyTag String
  order       Int
  lesson      Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  responses   SessionResponse[]

  @@unique([lessonId, order])
}

model UserProgress {
  id           String    @id @default(cuid())
  userId       String
  lessonId     String
  masteryScore Float     @default(0)
  completed    Boolean   @default(false)
  lastAttempt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lesson       Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Session {
  id        String            @id @default(cuid())
  userId    String
  lessonId  String
  startedAt DateTime          @default(now())
  score     Float?
  passed    Boolean           @default(false)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  responses SessionResponse[]
}

model SessionResponse {
  id        String     @id @default(cuid())
  sessionId String
  itemId    String
  answer    Int
  isCorrect Boolean
  timeMs    Int
  item      LessonItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  session   Session    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}
